<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主持遊戲</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", "微軟正黑體", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 90%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        /* 問答模式樣式 */
        .question-display {
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .options-stats {
            display: grid;
            gap: 15px;
        }

        .option-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .option-label {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .option-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .option-bar {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .option-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .correct-answer {
            border-left-color: #28a745;
        }

        .correct-answer .option-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
        }

        /* 回饋模式樣式 */
        .feedbacks-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .feedback-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .feedback-item.read {
            opacity: 0.6;
            border-left-color: #6c757d;
        }

        .feedback-text {
            color: #333;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .feedback-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #666;
        }

        .feedback-actions {
            display: flex;
            gap: 8px;
        }

        .feedback-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .feedback-btn.toggle-read {
            background: #007bff;
            color: white;
        }

        .feedback-btn.delete {
            background: #dc3545;
            color: white;
        }

        /* 排行榜樣式 */
        .leaderboard-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .leaderboard-rank {
            font-weight: bold;
            color: #667eea;
            width: 30px;
        }

        .leaderboard-name {
            flex: 1;
            color: #333;
            margin-left: 10px;
        }

        .leaderboard-score {
            font-weight: bold;
            color: #28a745;
            font-size: 1.1em;
        }

        /* 控制按鈕 */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .control-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .control-btn.prev {
            background: #6c757d;
            color: white;
        }

        .control-btn.prev:hover {
            background: #5a6268;
        }

        .control-btn.next {
            background: #007bff;
            color: white;
        }

        .control-btn.next:hover {
            background: #0056b3;
        }

        .control-btn.end {
            background: #dc3545;
            color: white;
        }

        .control-btn.end:hover {
            background: #c82333;
        }

        .control-btn.clear {
            background: #ffc107;
            color: #333;
        }

        .control-btn.clear:hover {
            background: #e0a800;
        }

        /* 統計資訊 */
        .stats-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-info .stat-item {
            display: inline-block;
            margin: 0 15px;
            color: #666;
        }

        .stats-info .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .control-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <a href="host-dashboard.html" class="back-btn">← 返回儀表板</a>

    <div class="container">
        <header>
            <h1 id="activityTitle">主持遊戲</h1>
        </header>

        <div id="errorContainer"></div>

        <div id="qaMode" style="display: none;">
            <div class="main-content">
                <div class="card">
                    <div class="card-title">當前問題</div>
                    <div class="question-display">
                        <div class="question-text" id="questionText"></div>
                        <div class="options-stats" id="optionsStats"></div>
                    </div>
                    <div class="controls">
                        <button class="control-btn prev" onclick="previousQuestion()">上一題</button>
                        <button class="control-btn next" onclick="nextQuestion()">下一題</button>
                        <button class="control-btn end" onclick="endActivity()">結束活動</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">即時排行榜</div>
                    <div class="stats-info">
                        <div class="stat-item">
                            <span class="stat-value" id="participantCount">0</span>
                            <span>參與者</span>
                        </div>
                    </div>
                    <div class="leaderboard-list" id="leaderboardList"></div>
                </div>
            </div>
        </div>

        <div id="feedbackMode" style="display: none;">
            <div class="card">
                <div class="card-title">即時回饋</div>
                <div class="stats-info">
                    <div class="stat-item">
                        <span class="stat-value" id="feedbackCount">0</span>
                        <span>回饋總數</span>
                    </div>
                </div>
                <div class="feedbacks-list" id="feedbacksList"></div>
                <div class="controls">
                    <button class="control-btn clear" onclick="clearAllFeedbacks()">清除所有回饋</button>
                    <button class="control-btn end" onclick="endActivity()">結束活動</button>
                </div>
            </div>
        </div>
    </div>

    <script src="activity-manager.js"></script>
    <script>
        let roomId = null;
        let activity = null;
        let syncInterval = null;

        // 取得 URL 參數
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 載入活動
        function loadActivity() {
            roomId = getUrlParameter('room');
            if (!roomId) {
                showError('缺少房間 ID，請從儀表板進入');
                return;
            }

            activity = ActivityManager.getActivity(roomId);
            if (!activity) {
                showError('活動不存在或已被刪除');
                return;
            }

            if (activity.status === 'ended') {
                showError('活動已結束');
                return;
            }

            document.getElementById('activityTitle').textContent = activity.title;

            if (activity.type === 'qa') {
                showQAMode();
            } else {
                showFeedbackMode();
            }

            // 開始同步
            startSyncing();
        }

        // 顯示問答模式
        function showQAMode() {
            document.getElementById('qaMode').style.display = 'block';
            document.getElementById('feedbackMode').style.display = 'none';
            updateQAView();
        }

        // 顯示回饋模式
        function showFeedbackMode() {
            document.getElementById('qaMode').style.display = 'none';
            document.getElementById('feedbackMode').style.display = 'block';
            updateFeedbackView();
        }

        // 更新問答視圖
        function updateQAView() {
            if (!activity || !activity.questions || activity.questions.length === 0) {
                return;
            }

            const currentIndex = activity.currentQuestion || 0;
            const question = activity.questions[currentIndex];

            if (!question) return;

            document.getElementById('questionText').textContent = 
                `問題 ${currentIndex + 1}/${activity.questions.length}: ${question.question}`;

            // 更新選項統計
            const optionsStats = document.getElementById('optionsStats');
            const totalResponses = Object.values(question.responses || {}).reduce((a, b) => a + b, 0);

            optionsStats.innerHTML = question.options.map((option, index) => {
                const count = question.responses && question.responses[index] ? question.responses[index] : 0;
                const percentage = totalResponses > 0 ? (count / totalResponses * 100).toFixed(1) : 0;
                const isCorrect = question.correctAnswer === index;

                return `
                    <div class="option-stat ${isCorrect ? 'correct-answer' : ''}">
                        <div class="option-header">
                            <span class="option-label">${String.fromCharCode(65 + index)}. ${option}</span>
                            <span class="option-count">${count} 人</span>
                        </div>
                        <div class="option-bar">
                            <div class="option-fill" style="width: ${percentage}%">
                                ${percentage > 0 ? percentage + '%' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // 更新排行榜
            updateLeaderboard();
        }

        // 更新排行榜
        function updateLeaderboard() {
            const leaderboard = activity.leaderboard || [];
            const list = document.getElementById('leaderboardList');

            if (leaderboard.length === 0) {
                list.innerHTML = '<div class="empty-message">還沒有參與者</div>';
            } else {
                list.innerHTML = leaderboard.slice(0, 10).map((participant, index) => `
                    <div class="leaderboard-item">
                        <span class="leaderboard-rank">${index + 1}</span>
                        <span class="leaderboard-name">${escapeHtml(participant.name)}</span>
                        <span class="leaderboard-score">${participant.score} 分</span>
                    </div>
                `).join('');
            }

            // 更新參與者數量
            const participantCount = ActivityManager.getParticipantCount(roomId);
            document.getElementById('participantCount').textContent = participantCount;
        }

        // 更新回饋視圖
        function updateFeedbackView() {
            const feedbacks = activity.feedbacks || [];
            const list = document.getElementById('feedbacksList');

            document.getElementById('feedbackCount').textContent = feedbacks.length;

            if (feedbacks.length === 0) {
                list.innerHTML = '<div class="empty-message">還沒有回饋</div>';
            } else {
                list.innerHTML = feedbacks.map(feedback => `
                    <div class="feedback-item ${feedback.read ? 'read' : ''}">
                        <div class="feedback-text">${escapeHtml(feedback.text)}</div>
                        <div class="feedback-meta">
                            <span>${formatDate(feedback.timestamp)}</span>
                            <div class="feedback-actions">
                                <button class="feedback-btn toggle-read" onclick="toggleFeedbackRead(${feedback.id})">
                                    ${feedback.read ? '標記未讀' : '標記已讀'}
                                </button>
                                <button class="feedback-btn delete" onclick="deleteFeedback(${feedback.id})">刪除</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // 上一題
        function previousQuestion() {
            if (!activity || activity.type !== 'qa') return;
            const currentIndex = activity.currentQuestion || 0;
            if (currentIndex > 0) {
                ActivityManager.updateCurrentQuestion(roomId, currentIndex - 1);
                activity = ActivityManager.getActivity(roomId);
                updateQAView();
            }
        }

        // 下一題
        function nextQuestion() {
            if (!activity || activity.type !== 'qa') return;
            const currentIndex = activity.currentQuestion || 0;
            if (currentIndex < activity.questions.length - 1) {
                ActivityManager.updateCurrentQuestion(roomId, currentIndex + 1);
                activity = ActivityManager.getActivity(roomId);
                updateQAView();
            }
        }

        // 結束活動
        function endActivity() {
            if (confirm('確定要結束這個活動嗎？')) {
                ActivityManager.updateActivityStatus(roomId, 'ended');
                alert('活動已結束');
                window.location.href = 'host-dashboard.html';
            }
        }

        // 標記回饋已讀/未讀
        function toggleFeedbackRead(feedbackId) {
            ActivityManager.toggleFeedbackRead(roomId, feedbackId);
            activity = ActivityManager.getActivity(roomId);
            updateFeedbackView();
        }

        // 刪除回饋
        function deleteFeedback(feedbackId) {
            if (confirm('確定要刪除這則回饋嗎？')) {
                ActivityManager.deleteFeedback(roomId, feedbackId);
                activity = ActivityManager.getActivity(roomId);
                updateFeedbackView();
            }
        }

        // 清除所有回饋
        function clearAllFeedbacks() {
            if (confirm('確定要清除所有回饋嗎？此操作無法復原。')) {
                ActivityManager.clearAllFeedbacks(roomId);
                activity = ActivityManager.getActivity(roomId);
                updateFeedbackView();
            }
        }

        // 開始同步
        function startSyncing() {
            syncInterval = setInterval(() => {
                const updatedActivity = ActivityManager.getActivity(roomId);
                if (updatedActivity) {
                    activity = updatedActivity;
                    if (activity.type === 'qa') {
                        updateQAView();
                    } else {
                        updateFeedbackView();
                    }
                }
            }, 2000); // 每 2 秒同步一次
        }

        // 停止同步
        function stopSyncing() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // 顯示錯誤
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
        }

        // 工具函數
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 頁面卸載時停止同步
        window.addEventListener('beforeunload', stopSyncing);

        // 初始化
        loadActivity();
    </script>
</body>
</html>

